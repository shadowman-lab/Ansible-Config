---

# we need a variable to the "changed" admin account name since control XXXX states acct must be renamed
# enumerating on DC is different than standalone
# DC == Get-ADUser -Filter * -Properties SID, PasswordLastSet | Where SID -Like "*-500" | Ft Name, SID, PasswordLastSet
- name: "MEDIUM | WN16-00-000030 | Passwords for the built-in Administrator account must be changed at least every 60 days."
  block:
      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN CONTROLLER | Passwords for the built-in Administrator account must be changed at least every 60 days."
        ansible.windows.win_shell: "Get-ADUser -Filter * -Property PasswordLastSet | Where SID -like S-1-5-21-*-500 | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16_00_000030_pass_age }}))} | Select Name,PasswordLastSet"
        # ansible.windows.win_shell: "Get-ADUser krbtgt -Property PasswordLastSet | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16_dc_000430_pass_age }}))} | Select-Object -ExpandProperty PasswordLastSet"
        register: wn16_00_000030_audit_dc
        check_mode: no
        changed_when: wn16_00_000030_audit_dc.stdout != ""
        when: ansible_windows_domain_role == "Primary domain controller"
      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN CONTROLLER | Passwords for the built-in Administrator account must be changed at least every 60 days."
        ansible.builtin.debug:
            msg:
                - "The following account appears to be the default admin account and the password does not meet the control specific age of {{ wn16_00_000030_pass_age }}"
                - "{{ wn16_00_000030_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000030_audit_dc is not skipped
            - wn16_00_000030_audit_dc.stdout != ""
        changed_when: yes

      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Passwords for the built-in Administrator account must be changed at least every 60 days."
        ansible.windows.win_shell: "Get-Localuser -Name * | Select * | Where SID -like S-1-5-21-*-500 | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16_00_000030_pass_age }}))} | Select Name,PasswordLastSet"
        register: wn16_00_000030_audit_dm_sa
        changed_when: wn16_00_000030_audit_dm_sa.stdout != ""
        when: not ansible_windows_domain_role == "Primary domain controller"
      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Passwords for the built-in Administrator account must be changed at least every 60 days."
        ansible.builtin.debug:
            msg:
                - "The following account appears to be the default admin account and the password does not meet the control specific age of {{ wn16_00_000030_pass_age }}"
                - "{{ wn16_00_000030_audit_dm_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000030_audit_dm_sa is not skipped
            - wn16_00_000030_audit_dm_sa.stdout != ""
        changed_when: yes
  when:
      - wn16_00_000030
  tags:
      - WN16-00-000030
      - SV-87875r2

- name: "MEDIUM | WN16-00-000050 | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
  block:
      - name: "MEDIUM | WN16-00-000050 | AUDIT STAND-ALONE AND MEMBER SERVERS | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
        ansible.windows.win_shell: Get-LocalGroupMember -Name 'Backup Operators'
        register: wn16_00_000050_audit
        check_mode: no
        changed_when: wn16_00_000050_audit.stdout != ""
      - name: "MEDIUM | WN16-00-000050 | AUDIT STAND-ALONE AND MEMBER SERVERS | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
        ansible.builtin.debug:
            msg:
                - The accounts listed are members of the Backup Operators group
                - "{{ wn16_00_000050_audit.stdout.split('\n') }}"
        when:
            - wn16_00_000050_audit is not skipped
            - wn16_00_000050_audit.stdout != ""
        changed_when: yes
  when:
      - wn16_00_000050
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-00-000050
      - SV-87879r1
      - SRG-OS-000480-GPOS-00227
      - CCI-000366

- name: "MEDIUM | WN16-00-000060 | Manually managed application account passwords must be at least 15 characters in length."
  block:
      - name: "MEDIUM | WN16-00-000060 | AUDIT | Manually managed application account passwords must be at least 15 characters in length."
        ansible.windows.win_shell: echo true
        register: wn16_00_000060_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000060 | PATCH | Manually managed application account passwords must be at least 15 characters in length."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000060
  tags:
      - WN16-00-000060
      - SV-87881r1
      - notimplemented
      - notest
      # how to make this list?

- name: "MEDIUM | WN16-00-000070 | Manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."
  block:
      - name: "MEDIUM | WN16-00-000070 | AUDIT | Manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."
        ansible.windows.win_shell: echo true
        register: wn16_00_000070_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000070 | PATCH | Manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000070
  tags:
      - WN16-00-000070
      - SV-87883r2
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - notimplemented
      - notest
      # how to make this list?

- name: "MEDIUM | WN16-00-000080 | Shared user accounts must not be permitted on the system."
  block:
      - name: "MEDIUM | WN16-00-000080 | AUDIT | Shared user accounts must not be permitted on the system."
        ansible.windows.win_shell: echo true
        register: wn16_00_000080_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000080 | PATCH | Shared user accounts must not be permitted on the system."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000080
  tags:
      - WN16-00-000080
      - SV-87885r2
      - notimplemented
      - notest
      # org has to supply a list? shared acct must be in SSP?

- name: "MEDIUM | WN16-00-000090 | Windows Server 2016 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."
  block:
      - name: "MEDIUM | WN16-00-000090 | AUDIT | Windows Server 2016 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."
        ansible.windows.win_shell: echo true
        register: wn16_00_000090_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000090 | PATCH | Windows Server 2016 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000090
  tags:
      - WN16-00-000090
      - SV-87887r2
      - notimplemented
      - notest
      # Get-AppLockerPolicy -Effective

- name: "MEDIUM | WN16-00-000100 | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use."
  block:
      - name: "MEDIUM | WN16-00-000100 | AUDIT | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use."
        ansible.windows.win_shell: echo true
        register: wn16_00_000100_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000100 | PATCH | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use."
        ansible.windows.win_shell: echo true
        changed_when: no
        # Current hardware and virtual environments may not support virtualization-based security features, including Credential Guard, due to specific supporting requirements including a TPM, UEFI with Secure Boot, and the capability to run the Hyper-V feature within a virtual machine.
  when:
      - wn16_00_000100
  tags:
      - WN16-00-000100
      - SV-87889r2
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - notimplemented
      - notest
      # wmic /namespace:\\root\cimv2\security\microsofttpm path win32_tpm get *
      # if not enabled see "No Instance(s) Available." ?

- name: "MEDIUM | WN16-00-000140 | Servers must have a host-based intrusion detection or prevention system."
  block:
      - name: "MEDIUM | WN16-00-000140 | AUDIT | Servers must have a host-based intrusion detection or prevention system."
        ansible.windows.win_shell: echo true
        register: wn16_00_000140_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000140 | PATCH | Servers must have a host-based intrusion detection or prevention system."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000140
  tags:
      - WN16-00-000140
      - SV-87897r1
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - notimplemented
      - notest
      # think this is mcafee but need install and figure out paths for AV vs HIDS and/or running services?

- name: "MEDIUM | WN16-00-000160 | Permissions for the system drive root directory usually C:\ must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN16-00-000160 | AUDIT | Permissions for the system drive root directory usually C:\ must conform to minimum requirements."
        ansible.windows.win_shell: echo true
        register: wn16_00_000160_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000160 | PATCH | Permissions for the system drive root directory usually C:\ must conform to minimum requirements."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000160
  tags:
      - WN16-00-000160
      - SV-87901r1
      - notimplemented
      - notest
      # investigate icacls https://ss64.com/nt/icacls.html ?

- name: "MEDIUM | WN16-00-000170 | Permissions for program file directories must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements."
        ansible.windows.win_shell: echo true
        register: wn16_00_000170_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000170 | PATCH | Permissions for program file directories must conform to minimum requirements."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000170
  tags:
      - WN16-00-000170
      - SV-87903r1
      - notimplemented
      - notest
      # same icalcs as above?

- name: "MEDIUM | WN16-00-000180 | Permissions for the Windows installation directory must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN16-00-000180 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements."
        ansible.windows.win_shell: echo true
        register: wn16_00_000180_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000180 | PATCH | Permissions for the Windows installation directory must conform to minimum requirements."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000180
  tags:
      - WN16-00-000180
      - SV-87905r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000190 | Default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."
  block:
      - name: "MEDIUM | WN16-00-000190 | AUDIT | Default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."
        ansible.windows.win_shell: echo true
        register: wn16_00_000190_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000190 | PATCH | Default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000190
  tags:
      - WN16-00-000190
      - SV-87907r1
      - notimplemented
      - notest
      # Get-Acl -Path HKLM:\"Software"

- name: "MEDIUM | WN16-00-000210 | Outdated or unused accounts must be removed from the system or disabled."
  block:
      - name: "MEDIUM | WN16-00-000210 | AUDIT | Outdated or unused accounts must be removed from the system or disabled."
        ansible.windows.win_shell: echo true
        register: wn16_00_000210_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000210 | PATCH | Outdated or unused accounts must be removed from the system or disabled."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000210
  tags:
      - WN16-00-000210
      - SV-87911r2
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000220 | Windows Server 2016 accounts must require passwords."
  block:
      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 accounts must require passwords."
        ansible.windows.win_shell: Get-Aduser -Filter "(Passwordnotrequired -eq 'True') -and (Enabled -eq 'True')" | Select Name,Passwordnotrequired,Enabled
        register: wn16_00_000220_audit_dc
        check_mode: no
        changed_when: wn16_00_000220_audit_dc.stdout != ""
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 accounts must require passwords."
        ansible.builtin.debug:
            msg:
                - The accounts listed are do not require a password and are currently enabled
                - "{{ wn16_00_000220_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000220_audit_dc is not skipped
            - wn16_00_000220_audit_dc.stdout != ""
        changed_when: yes

      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 accounts must require passwords."
        ansible.windows.win_shell: Get-LocalUser | Where-Object {($_.PasswordRequired -ne 'True' -and $_.Enabled -eq 'True')} | Select Name,PasswordRequired,Enabled
        register: wn16_00_000220_audit_dm_sa
        check_mode: no
        changed_when: wn16_00_000220_audit_dm_sa.stdout != ""
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000220 | AUDIT -DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 accounts must require passwords."
        ansible.builtin.debug:
            msg:
                - The accounts listed are do not require a password and are currently enabled
                - "{{ wn16_00_000220_audit_dm_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000220_audit_dm_sa is not skipped
            - wn16_00_000220_audit_dm_sa.stdout != ""
        changed_when: yes
  when:
      - wn16_00_000220
  tags:
      - WN16-00-000220
      - SV-87913r4

- name: "MEDIUM | WN16-00-000230 | Passwords must be configured to expire."
  block:
      - name: "MEDIUM | WN16-00-000230 | AUDIT | Passwords must be configured to expire."
        ansible.windows.win_shell: echo true
        register: wn16_00_000230_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000230 | PATCH | Passwords must be configured to expire."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000230
  tags:
      - WN16-00-000230
      - SV-87915r2
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000240 | System files must be monitored for unauthorized changes."
  block:
      - name: "MEDIUM | WN16-00-000240 | AUDIT | System files must be monitored for unauthorized changes."
        ansible.windows.win_shell: echo true
        register: wn16_00_000240_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000240 | PATCH | System files must be monitored for unauthorized changes."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000240
  tags:
      - WN16-00-000240
      - SV-87917r1
      - notimplemented
      - notest
      - mcaffee?

- name: "MEDIUM | WN16-00-000250 | Non-system-created file shares on a system must limit access to groups that require it."
  block:
      - name: "MEDIUM | WN16-00-000250 | AUDIT | Non-system-created file shares on a system must limit access to groups that require it."
        ansible.windows.win_shell: Get-SmbShare -special:$false
        register: wn16_00_000250_audit
        # failed_when: "'Get-SmbShare : No MSFT_SMBShare objects found with property 'Special' equal to 'False'' not in wn16_00_000250_audit.stdout"
        failed_when: "'No MSFT_SMBShare objects found' not in wn16_00_000250_audit.stderr"
        ignore_errors: yes
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000250 | AUDIT | Non-system-created file shares on a system must limit access to groups that require it."
        ansible.builtin.debug:
            msg: "{{ wn16_00_000250_audit.stdout_lines }}"
        when: wn16_00_000250_audit is failed
  when:
      - wn16_00_000250
  tags:
      - WN16-00-000250
      - SV-87919r1
      - notimplemented
      - notest

# https://stackoverflow.com/questions/31049454/how-to-retrieve-recursively-any-files-with-a-specific-extensions-in-powershell/31049571
- name: "MEDIUM | WN16-00-000270 | Software certificate installation files must be removed from Windows Server 2016."
  block:
      - name: "MEDIUM | WN16-00-000270 | AUDIT | Software certificate installation files must be removed from Windows Server 2016."
        ansible.windows.win_find:
            paths: C:\
            patterns: ['*.p12', '*.pfx']
            hidden: true
            recurse: true
            follow: true
        register: wn16_00_000270_audit
        check_mode: no
        changed_when: no
        # do we need async; its very long running to search filesystems

      - name: "MEDIUM | WN16-00-000270 | AUDIT | Software certificate installation files must be removed from Windows Server 2016."
        ansible.builtin.debug:
            msg: "{{ wn16_00_000270_audit.stdout_lines }}"
        when: wn16_00_000270_audit.stdout|default("") != ""
  when:
      - wn16_00_000270
      - not winstig_skip_for_test
  tags:
      - WN16-00-000270
      - SV-87923r2
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000280 | Systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
  block:
      - name: "MEDIUM | WN16-00-000280 | AUDIT | Systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
        ansible.windows.win_shell: echo true
        register: wn16_00_000280_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000280 | PATCH | Systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000280
  tags:
      - WN16-00-000280
      - SV-87925r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000290 | Protection methods such as TLS, encrypted VPNs, or IPsec must be implemented if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."
  block:
      - name: "MEDIUM | WN16-00-000290 | AUDIT | Protection methods such as TLS, encrypted VPNs, or IPsec must be implemented if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."
        ansible.windows.win_shell: echo true
        register: wn16_00_000290_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000290 | PATCH | Protection methods such as TLS, encrypted VPNs, or IPsec must be implemented if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000290
  tags:
      - WN16-00-000290
      - SV-87927r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000310 | A host-based firewall must be installed and enabled on the system."
  block:
      - name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system."
        ansible.windows.win_shell: echo true
        register: wn16_00_000310_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000310 | PATCH | A host-based firewall must be installed and enabled on the system."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000310
  tags:
      - WN16-00-000310
      - SV-87931r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000320 | Windows Server 2016 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."
  block:
      - name: "MEDIUM | WN16-00-000320 | AUDIT | Windows Server 2016 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."
        ansible.windows.win_shell: echo true
        register: wn16_00_000320_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000320 | PATCH | Windows Server 2016 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000320
  tags:
      - WN16-00-000320
      - SV-87933r2
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000330 | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours."
  block:
      - name: "MEDIUM | WN16-00-000330 | AUDIT | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours."
        ansible.windows.win_shell: echo true
        register: wn16_00_000330_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000330 | PATCH | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000330
  tags:
      - WN16-00-000330
      - SV-87935r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000340 | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."
  block:
      - name: "MEDIUM | WN16-00-000340 | AUDIT | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."
        ansible.windows.win_shell: echo true
        register: wn16_00_000340_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000340 | PATCH | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000340
  tags:
      - WN16-00-000340
      - notimplemented
      - notest
      # how? prompt customer provided name list? scan against local account names for unknown ones?

- name: "MEDIUM | WN16-00-000350 | The Fax Server role must not be installed."
  ansible.windows.win_feature:
      name: Fax
      state: absent
  notify:
      - reboot_windows
  when:
      - wn16_00_000350
  tags:
      - WN16-00-000350
      - xccdf_mil.disa.stig_rule_SV-87939r1_rule
      - tested

- name: "MEDIUM | WN16-00-000360 | The Microsoft FTP service must not be installed unless required."
  ansible.windows.win_feature:
      name: Web-Ftp-Server
      state: absent
  notify:
      - reboot_windows
  when:
      - wn16_00_000360
  tags:
      - WN16-00-000360
      - xccdf_mil.disa.stig_rule_SV-87941r1_rule
      - tested

- name: "MEDIUM | WN16-00-000370 | The Peer Name Resolution Protocol must not be installed."
  ansible.windows.win_feature:
      name: PNRP
      state: absent
  notify:
      - reboot_windows
  when:
      - wn16_00_000370
  tags:
      - WN16-00-000370
      - xccdf_mil.disa.stig_rule_SV-87943r1_rule
      - tested

- name: "MEDIUM | WN16-00-000380 | Simple TCP/IP Services must not be installed."
  ansible.windows.win_feature:
      name: Simple-TCPIP
      state: absent
  when:
      - wn16_00_000380
  tags:
      - WN16-00-000380
      - xccdf_mil.disa.stig_rule_SV-87945r1_rule
      - tested

- name: "MEDIUM | WN16-00-000390 | The Telnet Client must not be installed."
  ansible.windows.win_feature:
      name: Telnet-Client
      state: absent
  when:
      - wn16_00_000390
  tags:
      - WN16-00-000390
      - xccdf_mil.disa.stig_rule_SV-87947r1_rule
      - tested

- name: "MEDIUM | WN16-00-000400 | The TFTP Client must not be installed."
  ansible.windows.win_feature:
      name: TFTP-Client
      state: absent
  when:
      - wn16_00_000400
  tags:
      - WN16-00-000400
      - xccdf_mil.disa.stig_rule_SV-87949r1_rule
      - tested

- name: "MEDIUM | WN16-00-000410 | The Server Message Block (SMB) v1 protocol must be uninstalled."
  ansible.windows.win_feature:
      name: FS-SMB1
      state: absent
  when:
      - wn16_00_000410
  tags:
      - WN16-00-000410
      - xccdf_mil.disa.stig_rule_SV-87951r2_rule
      - tested

- name: "MEDIUM | WN16-00-000420 | Windows PowerShell 2.0 must not be installed."
  ansible.windows.win_feature:
      name: PowerShell-V2
      state: absent
  when:
      - wn16_00_000420
  tags:
      - WN16-00-000420
      - xccdf_mil.disa.stig_rule_SV-87953r1_rule
      - tested

- name: "MEDIUM | WN16-00-000430 | FTP servers must be configured to prevent anonymous logons."
  block:
      - name: "MEDIUM | WN16-00-000430 | AUDIT | FTP servers must be configured to prevent anonymous logons."
        ansible.windows.win_shell: echo true
        register: wn16_00_000430_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000430 | PATCH | FTP servers must be configured to prevent anonymous logons."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000430
  tags:
      - WN16-00-000430
      - SV-87955r1
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - notimplemented
      - notest

- name: "MEDIUM | WN16-00-000440 | FTP servers must be configured to prevent access to the system drive."
  block:
      - name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive."
        ansible.windows.win_shell: echo true
        register: wn16_00_000440_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000440 | PATCH | FTP servers must be configured to prevent access to the system drive."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000440
  tags:
      - WN16-00-000440
      - SV-87957r1
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - notimplemented
      - notest

- name: "MEDIUM | WN16-AC-000020 | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less."
  community.windows.win_security_policy:
      section: System Access
      key: LockoutBadCount
      value: "{{ wn16_ac_000020_lockoutbadcount }}"
  when:
      - wn16_ac_000020
  tags:
      - WN16-AC-000020
      - SV-87963r2

# below task is dependent on WN16-AC-000020, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'ResetLockoutCount' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000030 | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
  block:
      - name: "MEDIUM | WN16-AC-000030 | AUDIT | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
        ansible.builtin.assert:
            that: wn16_ac_000030_resetlockoutcount | int is version('15', '>=')
            fail_msg: "Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater and variable wn16_ac_000030_resetlockoutcount is set to {{ wn16_ac_000030_resetlockoutcount }}"
        ignore_errors: yes

      - name: "MEDIUM | WN16-AC-000030 | PATCH | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
        community.windows.win_security_policy:
            section: System Access
            key: ResetLockoutCount
            value: "{{ wn16_ac_000030_resetlockoutcount }}"
  when:
      - wn16_ac_000030
  tags:
      - WN16-AC-000030
      - SV-87965r2

# below task is dependent on WN16-AC-000020 and WN16-AC-000030, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'LockoutDuration' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000010 | Windows 2016 account lockout duration must be configured to 15 minutes or greater."
  block:
      - name: "MEDIUM | WN16-AC-000010 | AUDIT | Windows 2016 account lockout duration must be configured to 15 minutes or greater."
        ansible.builtin.assert:
            that: wn16_ac_000010_lockoutduration | int is version('15', '<=')
            fail_msg: "Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater and variable wn16_ac_000010_lockoutduration is set to {{ wn16_ac_000010_lockoutduration }}"
        ignore_errors: yes

      - name: "MEDIUM | WN16-AC-000010 | PATCH | Windows 2016 account lockout duration must be configured to 15 minutes or greater."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutDuration
            value: "{{ wn16_ac_000010_lockoutduration }}"
  when:
      - wn16_ac_000010
  tags:
      - WN16-AC-000010
      - SV-87961r3

- name: "MEDIUM | WN16-AC-000040 | Windows Server 2016 password history must be configured to 24 passwords remembered."
  block:
      - name: "MEDIUM | WN16-AC-000040 | AUDIT | Windows Server 2016 password history must be configured to 24 passwords remembered."
        ansible.builtin.assert:
            that: wn16_ac_000040_passwordhistorysize | int is version('24', '>=')
            fail_msg: "Windows Server 2016 password history must be configured to 24 passwords remembered and variable wn16_ac_000040_passwordhistorysize is set to {{ wn16_ac_000040_passwordhistorysize }}"
        ignore_errors: yes

      - name: "MEDIUM | WN16-AC-000040 | PATCH | Windows Server 2016 password history must be configured to 24 passwords remembered."
        community.windows.win_security_policy:
            section: System Access
            key: PasswordHistorySize
            value: "{{ wn16_ac_000040_passwordhistorysize }}"
  when:
      - wn16_ac_000040
  tags:
      - WN16-AC-000040
      - SV-87967r2_rule

- name: "MEDIUM | WN16-AC-000050 | Windows Server 2016 maximum password age must be configured to 60 days or less."
  block:
      - name: "MEDIUM | WN16-AC-000050 |  AUDIT | Windows Server 2016 maximum password age must be configured to 60 days or less."
        ansible.builtin.assert:
            that: wn16_ac_000050_maximumpasswordage | int is version('60', '<=')
            fail_msg: "Windows Server 2016 maximum password age must be configured to 60 days or less and variable wn16_ac_000050_maximumpasswordage is set to {{ wn16_ac_000050_maximumpasswordage }}"
        ignore_errors: yes

      - name: "MEDIUM | WN16-AC-000050 |  PATCH | Windows Server 2016 maximum password age must be configured to 60 days or less."
        community.windows.win_security_policy:
            section: System Access
            key: MaximumPasswordAge
            value: "{{ wn16_ac_000050_maximumpasswordage }}"
  when:
      - wn16_ac_000050
  tags:
      - WN16-AC-000050
      - SV-87969r2

- name: "MEDIUM | WN16-AC-000060 | Windows Server 2016 minimum password age must be configured to at least one day."
  block:
      - name: "MEDIUM | WN16-AC-000060 | AUDIT | Windows Server 2016 minimum password age must be configured to at least one day."
        ansible.builtin.assert:
            that: wn16_ac_000060_minimumpasswordage is version('1', '>=')
            fail_msg: "Windows Server 2016 minimum password age must be configured to at least one day and variable wn16_ac_000060_minimumpasswordage is set to {{ wn16_ac_000060_minimumpasswordage }}"
        ignore_errors: yes

      - name: "MEDIUM | WN16-AC-000060 | PATCH | Windows Server 2016 minimum password age must be configured to at least one day."
        community.windows.win_security_policy:
            section: System Access
            key: MinimumPasswordAge
            value: "{{ wn16_ac_000060_minimumpasswordage }}"
  when:
      - wn16_ac_000060
  tags:
      - WN16-AC-000060
      - SV-87971r2_rule

- name: "MEDIUM | WN16-AC-000070 | Windows Server 2016 minimum password length must be configured to 14 characters."
  block:
      - name: "MEDIUM | WN16-AC-000070 | AUDIT | Windows Server 2016 minimum password length must be configured to 14 characters."
        ansible.builtin.assert:
            that: wn16_ac_000070_minimumpasswordlength is version('14', '>=')
            fail_msg: "Windows Server 2016 minimum password length must be configured to 14 characters and variable wn16_ac_000070_minimumpasswordlength is set to {{ wn16_ac_000070_minimumpasswordlength }} characters"
        ignore_errors: yes

      - name: "MEDIUM | WN16-AC-000070 | PATCH | Windows Server 2016 minimum password length must be configured to 14 characters."
        community.windows.win_security_policy:
            section: System Access
            key: MinimumPasswordLength
            value: "{{ wn16_ac_000070_minimumpasswordlength }}"
  when:
      - wn16_ac_000070
  tags:
      - WN16-AC-000070
      - SV-87973r2_rule

- name: "MEDIUM | WN16-AC-000080 | Windows Server 2016 must have the built-in Windows password complexity policy enabled."
  community.windows.win_security_policy:
      section: System Access
      key: PasswordComplexity
      value: 1
  when:
      - wn16_ac_000080
  tags:
      - WN16-AC-000080
      - SV-87975r2

- name: "MEDIUM | WN16-DC-000020 | Kerberos user logon restrictions must be enforced."
  block:
      - name: "MEDIUM | WN16-DC-000020 | AUDIT | Kerberos user logon restrictions must be enforced."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000020_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000020 | PATCH | Kerberos user logon restrictions must be enforced."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000020
  tags:
      - WN16-DC-000020
      - notimplemented

- name: "MEDIUM | WN16-DC-000030 | The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
  block:
      - name: "MEDIUM | WN16-DC-000030 | AUDIT | The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000030_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000030 | PATCH | The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000030
  tags:
      - WN16-DC-000030
      - notimplemented

- name: "MEDIUM | WN16-DC-000040 | The Kerberos user ticket lifetime must be limited to 10 hours or less."
  block:
      - name: "MEDIUM | WN16-DC-000040 | AUDIT | The Kerberos user ticket lifetime must be limited to 10 hours or less."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000040_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000040 | PATCH | The Kerberos user ticket lifetime must be limited to 10 hours or less."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000040
  tags:
      - WN16-DC-000040
      - notimplemented

- name: "MEDIUM | WN16-DC-000050 | The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
  block:
      - name: "MEDIUM | WN16-DC-000050 | AUDIT | The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000050_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000050 | PATCH | The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000050
  tags:
      - WN16-DC-000050
      - notimplemented

- name: "MEDIUM | WN16-DC-000060 | The computer clock synchronization tolerance must be limited to 5 minutes or less."
  block:
      - name: "MEDIUM | WN16-DC-000060 | AUDIT | The computer clock synchronization tolerance must be limited to 5 minutes or less."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000060_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000060 | PATCH | The computer clock synchronization tolerance must be limited to 5 minutes or less."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000060
  tags:
      - WN16-DC-000060
      - notimplemented

- name: "MEDIUM | WN16-DC-000120 | Data files owned by users must be on a different logical partition from the directory server data files."
  block:
      - name: "MEDIUM | WN16-DC-000120 | AUDIT | Data files owned by users must be on a different logical partition from the directory server data files."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000120_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000120 | PATCH | Data files owned by users must be on a different logical partition from the directory server data files."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000120
  tags:
      - WN16-DC-000120
      - notimplemented

- name: "MEDIUM | WN16-DC-000130 | Domain controllers must run on a machine dedicated to that function."
  block:
      - name: "MEDIUM | WN16-DC-000130 | AUDIT | Domain controllers must run on a machine dedicated to that function."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000130_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000130 | PATCH | Domain controllers must run on a machine dedicated to that function."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000130
  tags:
      - WN16-DC-000130
      - notimplemented

- name: "MEDIUM | WN16-DC-000140 | Separate, NSA-approved (Type 1) cryptography must be used to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."
  block:
      - name: "MEDIUM | WN16-DC-000140 | AUDIT | Separate, NSA-approved (Type 1) cryptography must be used to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000140_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000140 | PATCH | Separate, NSA-approved (Type 1) cryptography must be used to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000140
  tags:
      - WN16-DC-000140
      - notimplemented

- name: "MEDIUM | WN16-DC-000170 | Active Directory Group Policy objects must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000170 | AUDIT | Active Directory Group Policy objects must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000170_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000170 | PATCH | Active Directory Group Policy objects must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000170
  tags:
      - WN16-DC-000170
      - notimplemented

- name: "MEDIUM | WN16-DC-000180 | The Active Directory Domain object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000180 | AUDIT | The Active Directory Domain object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000180_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000180 | PATCH | The Active Directory Domain object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000180
  tags:
      - WN16-DC-000180
      - notimplemented

- name: "MEDIUM | WN16-DC-000190 | The Active Directory Infrastructure object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000190 | AUDIT | The Active Directory Infrastructure object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000190_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000190 | PATCH | The Active Directory Infrastructure object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000190
  tags:
      - WN16-DC-000190
      - notimplemented

- name: "MEDIUM | WN16-DC-000200 | The Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000200 | AUDIT | The Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000200_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000200 | PATCH | The Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000200
  tags:
      - WN16-DC-000200
      - notimplemented

- name: "MEDIUM | WN16-DC-000210 | The Active Directory AdminSDHolder object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000210 | AUDIT | The Active Directory AdminSDHolder object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000210_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000210 | PATCH | The Active Directory AdminSDHolder object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000210
  tags:
      - WN16-DC-000210
      - notimplemented

- name: "MEDIUM | WN16-DC-000220 | The Active Directory RID Manager$ object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000220 | AUDIT | The Active Directory RID Manager$ object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000220_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000220 | PATCH | The Active Directory RID Manager$ object must be configured with proper audit settings."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000220
  tags:
      - WN16-DC-000220
      - notimplemented

- name: "MEDIUM | WN16-AU-000010 | Audit records must be backed up to a different system or media than the system being audited."
  block:
      - name: "MEDIUM | WN16-AU-000010 | AUDIT | Audit records must be backed up to a different system or media than the system being audited."
        ansible.windows.win_shell: echo true
        register: wn16_au_000010_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-AU-000010 | PATCH | Audit records must be backed up to a different system or media than the system being audited."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_au_000010
  tags:
      - WN16-AU-000010
      - SV-88053r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-AU-000020 | Windows Server 2016 must, at a minimum, off-load audit records of interconnected systems in real time and off-load standalone systems weekly."
  block:
      - name: "MEDIUM | WN16-AU-000020 | AUDIT | Windows Server 2016 must, at a minimum, off-load audit records of interconnected systems in real time and off-load standalone systems weekly."
        ansible.windows.win_shell: echo true
        register: wn16_au_000020_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-AU-000020 | PATCH | Windows Server 2016 must, at a minimum, off-load audit records of interconnected systems in real time and off-load standalone systems weekly."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_au_000020
  tags:
      - WN16-AU-000020
      - SV-88055r1
      - notimplemented
      - notest
      # hard one, either need to standardize on say log shipping like splunk or other is set?

- name: "MEDIUM | WN16-AU-000030 | Permissions for the Application event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN16-AU-000030 | AUDIT | Permissions for the Application event log must prevent access by non-privileged accounts."
        ansible.windows.win_shell: echo true
        register: wn16_au_000030_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-AU-000030 | PATCH | Permissions for the Application event log must prevent access by non-privileged accounts."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_au_000030
  tags:
      - WN16-AU-000030
      - SV-88057r1
      - notimplemented
      - notest

- name: "MEDIUM | WN16-AU-000040 | Permissions for the Security event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN16-AU-000040 | AUDIT | Permissions for the Security event log must prevent access by non-privileged accounts."
        ansible.windows.win_shell: echo true
        register: wn16_au_000040_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-AU-000040 | PATCH | Permissions for the Security event log must prevent access by non-privileged accounts."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_au_000040
  tags:
      - WN16-AU-000040
      - notimplemented
      - notest

- name: "MEDIUM | WN16-AU-000050 | Permissions for the System event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN16-AU-000050 | AUDIT | Permissions for the System event log must prevent access by non-privileged accounts."
        ansible.windows.win_shell: echo true
        register: wn16_au_000050_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-AU-000050 | PATCH | Permissions for the System event log must prevent access by non-privileged accounts."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_au_000050
  tags:
      - WN16-AU-000050
      - notimplemented
      - notest

- name: "MEDIUM | WN16-AU-000060 | Event Viewer must be protected from unauthorized modification and deletion."
  block:
      - name: "MEDIUM | WN16-AU-000060 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion."
        ansible.windows.win_shell: echo true
        register: wn16_au_000060_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-AU-000060 | PATCH | Event Viewer must be protected from unauthorized modification and deletion."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_au_000060
  tags:
      - WN16-AU-000060
      - notimplemented
      - notest

- name: "MEDIUM | WN16-AU-000070 | Windows Server 2016 must be configured to audit Account Logon - Credential Validation successes."
  block:
      - name: "MEDIUM | WN16-AU-000070 | AUDIT | Windows Server 2016 must be configured to audit Account Logon - Credential Validation successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000070_audit
        check_mode: no

        changed_when: "'Success' not in wn16_au_000070_audit.stdout"
      - name: "MEDIUM | WN16-AU-000070 | PATCH | Windows Server 2016 must be configured to audit Account Logon - Credential Validation successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Credential Validation" /success:enable
        when: "'Success' not in wn16_au_000070_audit.stdout"
  when:
      - wn16_au_000070
  tags:
      - WN16-AU-000070
      - SV-88065r1

- name: "MEDIUM | WN16-AU-000080 | Windows Server 2016 must be configured to audit Account Logon - Credential Validation failures."
  block:
      - name: "MEDIUM | WN16-AU-000080 | AUDIT | Windows Server 2016 must be configured to audit Account Logon - Credential Validation failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000080_audit
        check_mode: no

        changed_when: "'Failure' not in wn16_au_000080_audit.stdout"
      - name: "MEDIUM | WN16-AU-000080 | PATCH | Windows Server 2016 must be configured to audit Account Logon - Credential Validation failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Credential Validation" /failure:enable
        when: "'Failure' not in wn16_au_000080_audit.stdout"
  when:
      - wn16_au_000080
  tags:
      - WN16-AU-000080
      - SV-88067r1

- name: "MEDIUM | WN16-DC-000230 | Windows Server 2016 must be configured to audit Account Management - Computer Account Management successes."
  block:
      - name: "MEDIUM | WN16-DC-000230 | AUDIT | Windows Server 2016 must be configured to audit Account Management - Computer Account Management successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Computer Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_dc_000230_audit
        check_mode: no
        changed_when: "'Success' not in wn16_dc_000230_audit.stdout"

      - name: "MEDIUM | WN16-DC-000230 | PATCH | Windows Server 2016 must be configured to audit Account Management - Computer Account Management successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Computer Account Management" /success:enable
        when: "'Success' not in wn16_dc_000230_audit.stdout"
  when:
      - wn16_dc_000230
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000230
      - SV-88069r1

- name: "MEDIUM | WN16-AU-000100 | Windows Server 2016 must be configured to audit Account Management - Other Account Management Events successes."
  block:
      - name: "MEDIUM | WN16-AU-000100 | AUDIT | Windows Server 2016 must be configured to audit Account Management - Other Account Management Events successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other Account Management Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000100_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000100_audit.stdout"

      - name: "MEDIUM | WN16-AU-000100 | PATCH | Windows Server 2016 must be configured to audit Account Management - Other Account Management Events successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other Account Management Events" /success:enable
        when: "'Success' not in wn16_au_000100_audit.stdout"
  when:
      - wn16_au_000100
  tags:
      - WN16-AU-000100
      - SV-88071r1

- name: "MEDIUM | WN16-AU-000120 | Windows Server 2016 must be configured to audit Account Management - Security Group Management successes."
  block:
      - name: "MEDIUM | WN16-AU-000120 | AUDIT | Windows Server 2016 must be configured to audit Account Management - Security Group Management successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000120_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000120_audit.stdout"

      - name: "MEDIUM | WN16-AU-000120 | PATCH | Windows Server 2016 must be configured to audit Account Management - Security Group Management successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
        when: "'Success' not in wn16_au_000120_audit.stdout"
  when:
      - wn16_au_000120
  tags:
      - WN16-AU-000120
      - SV-88075r1

- name: "MEDIUM | WN16-AU-000140 | Windows Server 2016 must be configured to audit Account Management - User Account Management successes."
  block:
      - name: "MEDIUM | WN16-AU-000140 | AUDIT | Windows Server 2016 must be configured to audit Account Management - User Account Management successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000140_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000140_audit.stdout"

      - name: "MEDIUM | WN16-AU-000140 | PATCH | Windows Server 2016 must be configured to audit Account Management - User Account Management successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"User Account Management" /success:enable
        when: "'Success' not in wn16_au_000140_audit.stdout"
  when:
      - wn16_au_000140
  tags:
      - WN16-AU-000140
      - SV-88079r1

- name: "MEDIUM | WN16-AU-000150 | Windows Server 2016 must be configured to audit Account Management - User Account Management failures."
  block:
      - name: "MEDIUM | WN16-AU-000150 | AUDIT | Windows Server 2016 must be configured to audit Account Management - User Account Management failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000150_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000150_audit.stdout"

      - name: "MEDIUM | WN16-AU-000150 | PATCH | Windows Server 2016 must be configured to audit Account Management - User Account Management failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"User Account Management" /failure:enable
        when: "'Failure' not in wn16_au_000150_audit.stdout"
  when:
      - wn16_au_000150
  tags:
      - WN16-AU-000150
      - SV-88081r1

- name: "MEDIUM | WN16-AU-000160 | Windows Server 2016 must be configured to audit Detailed Tracking - Plug and Play Events successes."
  block:
      - name: "MEDIUM | WN16-AU-000160 | AUDIT | Windows Server 2016 must be configured to audit Detailed Tracking - Plug and Play Events successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Plug and Play Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000160_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000160_audit.stdout"

      - name: "MEDIUM | WN16-AU-000160 | PATCH | Windows Server 2016 must be configured to audit Detailed Tracking - Plug and Play Events successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Plug and Play Events" /success:enable
        when: "'Success' not in wn16_au_000160_audit.stdout"
  when:
      - wn16_au_000160
  tags:
      - WN16-AU-000160
      - SV-88083r2

- name: "MEDIUM | WN16-AU-000170 | Windows Server 2016 must be configured to audit Detailed Tracking - Process Creation successes."
  block:
      - name: "MEDIUM | WN16-AU-000170 | AUDIT | Windows Server 2016 must be configured to audit Detailed Tracking - Process Creation successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Process Creation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000170_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000170_audit.stdout"

      - name: "MEDIUM | WN16-AU-000170 | PATCH | Windows Server 2016 must be configured to audit Detailed Tracking - Process Creation successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Process Creation" /success:enable
        when: "'Success' not in wn16_au_000170_audit.stdout"
  when:
      - wn16_au_000170
  tags:
      - WN16-AU-000170
      - SV-88085r1

- name: "MEDIUM | WN16-DC-000240 | Windows Server 2016 must be configured to audit DS Access - Directory Service Access successes."
  block:
      - name: "MEDIUM | WN16-DC-000240 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Access successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_dc_000240_audit
        check_mode: no
        changed_when: "'Success' not in wn16_dc_000240_audit.stdout"

      - name: "MEDIUM | WN16-DC-000240 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Access successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Access" /success:enable
        when: "'Success' not in wn16_dc_000240_audit.stdout"
  when:
      - wn16_dc_000240
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000240
      - SV-88087r1

- name: "MEDIUM | WN16-DC-000250 | Windows Server 2016 must be configured to audit DS Access - Directory Service Access failures."
  block:
      - name: "MEDIUM | WN16-DC-000250 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Access failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_dc_000250_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_dc_000250_audit.stdout"

      - name: "MEDIUM | WN16-DC-000250 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Access failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Access" /failure:enable
        when: "'Failure' not in wn16_dc_000250_audit.stdout"
  when:
      - wn16_dc_000250
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000250
      - SV-88089r1

- name: "MEDIUM | WN16-DC-000260 | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes successes."
  block:
      - name: "MEDIUM | WN16-DC-000260 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Changes" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_dc_000260_audit
        check_mode: no
        changed_when: "'Success' not in wn16_dc_000260_audit.stdout"

      - name: "MEDIUM | WN16-DC-000260 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Changes" /success:enable
        when: "'Success' not in wn16_dc_000260_audit.stdout"
  when:
      - wn16_dc_000260
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000260
      - SV-88091r1

- name: "MEDIUM | WN16-DC-000270 | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes failures."
  block:
      - name: "MEDIUM | WN16-DC-000270 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Changes" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_dc_000270_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_dc_000270_audit.stdout"

      - name: "MEDIUM | WN16-DC-000270 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Changes" /failure:enable
        when: "'Failure' not in wn16_dc_000270_audit.stdout"
  when:
      - wn16_dc_000270
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000270
      - SV-88093r1

- name: "MEDIUM | WN16-AU-000220 | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout successes."
  block:
      - name: "MEDIUM | WN16-AU-000220 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000220_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000220_audit.stdout"

      - name: "MEDIUM | WN16-AU-000220 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Account Lockout" /success:enable
        when: "'Success' not in wn16_au_000220_audit.stdout"
  when:
      - wn16_au_000220
  tags:
      - WN16-AU-000220
      - SV-88095r3

- name: "MEDIUM | WN16-AU-000230 | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout failures."
  block:
      - name: "MEDIUM | WN16-AU-000230 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000230_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000230_audit.stdout"

      - name: "MEDIUM | WN16-AU-000230 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Account Lockout" /failure:enable
        changed_when: "'Failure' not in wn16_au_000230_audit.stdout"
  when:
      - wn16_au_000230
  tags:
      - WN16-AU-000230
      - SV-88097r3

- name: "MEDIUM | WN16-AU-000240 | Windows Server 2016 must be configured to audit Logon/Logoff - Group Membership successes."
  block:
      - name: "MEDIUM | WN16-AU-000240 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Group Membership successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Group Membership" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000240_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000240_audit.stdout"

      - name: "MEDIUM | WN16-AU-000240 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Group Membership successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Group Membership" /success:enable
        changed_when: "'Success' not in wn16_au_000240_audit.stdout"
  when:
      - wn16_au_000240
  tags:
      - WN16-AU-000240
      - SV-88099r2

- name: "MEDIUM | WN16-AU-000250 | Windows Server 2016 must be configured to audit Logon/Logoff - Logoff successes."
  block:
      - name: "MEDIUM | WN16-AU-000250 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Logoff successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logoff" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000250_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000250_audit.stdout"

      - name: "MEDIUM | WN16-AU-000250 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logoff successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logoff" /success:enable
        changed_when: "'Success' not in wn16_au_000250_audit.stdout"
  when:
      - wn16_au_000250
  tags:
      - WN16-AU-000250
      - SV-88101r1

- name: "MEDIUM | WN16-AU-000260 | Windows Server 2016 must be configured to audit Logon/Logoff - Logon successes."
  block:
      - name: "MEDIUM | WN16-AU-000260 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Logon successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000260_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000260_audit.stdout"

      - name: "MEDIUM | WN16-AU-000260 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logon successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logon" /success:enable
        changed_when: "'Success' not in wn16_au_000260_audit.stdout"
  when:
      - wn16_au_000260
  tags:
      - WN16-AU-000260
      - SV-88103r1

- name: "MEDIUM | WN16-AU-000270 | Windows Server 2016 must be configured to audit Logon/Logoff - Logon failures."
  block:
      - name: "MEDIUM | WN16-AU-000270 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Logon failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000270_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000270_audit.stdout"

      - name: "MEDIUM | WN16-AU-000270 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logon failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logon" /failure:enable
        when: "'Failure' not in wn16_au_000270_audit.stdout"
  when:
      - wn16_au_000270
  tags:
      - WN16-AU-000270
      - SV-88105r1

- name: "MEDIUM | WN16-AU-000280 | Windows Server 2016 must be configured to audit Logon/Logoff - Special Logon successes."
  block:
      - name: "MEDIUM | WN16-AU-000280 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Special Logon successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Special Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000280_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000280_audit.stdout"

      - name: "MEDIUM | WN16-AU-000280 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Special Logon successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Special Logon" /success:enable
        when: "'Success' not in wn16_au_000280_audit.stdout"
  when:
      - wn16_au_000280
  tags:
      - WN16-AU-000280
      - SV-88107r1

- name: "MEDIUM | WN16-AU-000290 | Windows Server 2016 must be configured to audit Object Access - Removable Storage successes."
  block:
      - name: "MEDIUM | WN16-AU-000290 | AUDIT | Windows Server 2016 must be configured to audit Object Access - Removable Storage successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000290_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000290_audit.stdout"

      - name: "MEDIUM | WN16-AU-000290 | PATCH | Windows Server 2016 must be configured to audit Object Access - Removable Storage successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
        when: "'Success' not in wn16_au_000290_audit.stdout"
  when:
      - wn16_au_000290
  tags:
      - WN16-AU-000290
      - SV-88109r1

- name: "MEDIUM | WN16-AU-000300 | Windows Server 2016 must be configured to audit Object Access - Removable Storage failures."
  block:
      - name: "MEDIUM | WN16-AU-000300 | AUDIT | Windows Server 2016 must be configured to audit Object Access - Removable Storage failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000300_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000300_audit.stdout"

      - name: "MEDIUM | WN16-AU-000300 | PATCH | Windows Server 2016 must be configured to audit Object Access - Removable Storage failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Removable Storage" /failure:enable
        when: "'Failure' not in wn16_au_000300_audit.stdout"
  when:
      - wn16_au_000300
  tags:
      - WN16-AU-000300
      - SV-88111r1

- name: "MEDIUM | WN16-AU-000310 | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000310 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000310_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000310_audit.stdout"

      - name: "MEDIUM | WN16-AU-000310 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Audit Policy Change" /success:enable
        when: "'Success' not in wn16_au_000310_audit.stdout"
  when:
      - wn16_au_000310
  tags:
      - WN16-AU-000310
      - SV-88113r1

- name: "MEDIUM | WN16-AU-000320 | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change failures."
  block:
      - name: "MEDIUM | WN16-AU-000320 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000320_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000320_audit.stdout"

      - name: "MEDIUM | WN16-AU-000320 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Audit Policy Change" /failure:enable
        when: "'Failure' not in wn16_au_000320_audit.stdout"
  when:
      - wn16_au_000320
  tags:
      - WN16-AU-000320
      - SV-88115r1

- name: "MEDIUM | WN16-AU-000330 | Windows Server 2016 must be configured to audit Policy Change - Authentication Policy Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000330 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Authentication Policy Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Authentication Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000330_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000330_audit.stdout"

      - name: "MEDIUM | WN16-AU-000330 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Authentication Policy Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Authentication Policy Change" /success:enable
        when: "'Success' not in wn16_au_000330_audit.stdout"
  when:
      - wn16_au_000330
  tags:
      - WN16-AU-000330
      - SV-88117r1

- name: "MEDIUM | WN16-AU-000340 | Windows Server 2016 must be configured to audit Policy Change - Authorization Policy Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000340 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Authorization Policy Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Authorization Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000340_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000340_audit.stdout"

      - name: "MEDIUM | WN16-AU-000340 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Authorization Policy Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
        when: "'Success' not in wn16_au_000340_audit.stdout"
  when:
      - wn16_au_000340
  tags:
      - WN16-AU-000340
      - SV-88119r1

- name: "MEDIUM | WN16-AU-000350 | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
  block:
      - name: "MEDIUM | WN16-AU-000350 | AUDIT | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000350_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000350_audit.stdout"

      - name: "MEDIUM | WN16-AU-000350 | PATCH | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /success:enable
        when: "'Success' not in wn16_au_000350_audit.stdout"
  when:
      - wn16_au_000350
  tags:
      - WN16-AU-000350
      - SV-88121r1

- name: "MEDIUM | WN16-AU-000360 | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
  block:
      - name: "MEDIUM | WN16-AU-000360 | AUDIT | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000360_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000360_audit.stdout"

      - name: "MEDIUM | WN16-AU-000360 | PATCH | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /failure:enable
        when: "'Failure' not in wn16_au_000360_audit.stdout"
  when:
      - wn16_au_000360
  tags:
      - WN16-AU-000360
      - SV-88123r1

- name: "MEDIUM | WN16-AU-000370 | Windows Server 2016 must be configured to audit System - IPsec Driver successes."
  block:
      - name: "MEDIUM | WN16-AU-000370 | AUDIT | Windows Server 2016 must be configured to audit System - IPsec Driver successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000370_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000370_audit.stdout"

      - name: "MEDIUM | WN16-AU-000370 | PATCH | Windows Server 2016 must be configured to audit System - IPsec Driver successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"IPsec Driver" /success:enable
        when: "'Success' not in wn16_au_000370_audit.stdout"
  when:
      - wn16_au_000370
  tags:
      - WN16-AU-000370
      - xccdf_mil.disa.stig_rule_SV-88125r1_rule
      - tested

- name: "MEDIUM | WN16-AU-000380 | Windows Server 2016 must be configured to audit System - IPsec Driver failures."
  block:
      - name: "MEDIUM | WN16-AU-000380 | AUDIT | Windows Server 2016 must be configured to audit System - IPsec Driver failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000380_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000380_audit.stdout"
      - ansible.builtin.debug:
            var: wn16_au_000380_audit

      - name: "MEDIUM | WN16-AU-000380 | PATCH | Windows Server 2016 must be configured to audit System - IPsec Driver failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"IPsec Driver" /failure:enable
        when: "'Failure' not in wn16_au_000380_audit.stdout"
  when:
      - wn16_au_000380
  tags:
      - WN16-AU-000380
      - xccdf_mil.disa.stig_rule_SV-88127r1_rule
      - tested

- name: "MEDIUM | WN16-AU-000390 | Windows Server 2016 must be configured to audit System - Other System Events successes."
  block:
      - name: "MEDIUM | WN16-AU-000390 | AUDIT | Windows Server 2016 must be configured to audit System - Other System Events successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000390_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000390_audit.stdout"

      - name: "MEDIUM | WN16-AU-000390 | PATCH | Windows Server 2016 must be configured to audit System - Other System Events successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other System Events" /success:enable
        when: "'Success' not in wn16_au_000390_audit.stdout"
  when:
      - wn16_au_000390
  tags:
      - WN16-AU-000390
      - xccdf_mil.disa.stig_rule_SV-88129r3_rule
      - tested

- name: "MEDIUM | WN16-AU-000400 | Windows Server 2016 must be configured to audit System - Other System Events failures."
  block:
      - name: "MEDIUM | WN16-AU-000400 | AUDIT | Windows Server 2016 must be configured to audit System - Other System Events failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000400_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000400_audit.stdout"

      - name: "MEDIUM | WN16-AU-000400 | PATCH | Windows Server 2016 must be configured to audit System - Other System Events failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other System Events" /failure:enable
        check_mode: no
        when: "'Failure' not in wn16_au_000400_audit.stdout"
  when:
      - wn16_au_000400
  tags:
      - WN16-AU-000400
      - xccdf_mil.disa.stig_rule_SV-88131r3_rule
      - tested

- name: "MEDIUM | WN16-AU-000410 | Windows Server 2016 must be configured to audit System - Security State Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000410 | AUDIT | Windows Server 2016 must be configured to audit System - Security State Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security State Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000410_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000410_audit.stdout"

      - name: "MEDIUM | WN16-AU-000410 | PATCH | Windows Server 2016 must be configured to audit System - Security State Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security State Change" /success:enable
        check_mode: no
        when: "'Success' not in wn16_au_000410_audit.stdout"
  when:
      - wn16_au_000410
  tags:
      - WN16-AU-000410
      - xccdf_mil.disa.stig_rule_SV-88133r1_rule
      - tested

- name: "MEDIUM | WN16-AU-000420 | Windows Server 2016 must be configured to audit System - Security System Extension successes."
  block:
      - name: "MEDIUM | WN16-AU-000420 | AUDIT | Windows Server 2016 must be configured to audit System - Security System Extension successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security System Extension" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000420_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000420_audit.stdout"

      - name: "MEDIUM | WN16-AU-000420 | PATCH | Windows Server 2016 must be configured to audit System - Security System Extension successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security System Extension" /success:enable
        check_mode: no
        when: "'Success' not in wn16_au_000420_audit.stdout"
  when:
      - wn16_au_000420
  tags:
      - WN16-AU-000420
      - xccdf_mil.disa.stig_rule_SV-88135r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000280 | Administrator accounts must not be enumerated during elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\CredUI
      state: present
      value: EnumerateAdministrators
      data: 0
      datatype: dword
  when:
      - wn16_cc_000280
  tags:
      - WN16-CC-000280
      - xccdf_mil.disa.stig_rule_SV-88139r1_rule
      - tested

- name: "MEDIUM | WN16-AU-000440 | Windows Server 2016 must be configured to audit System - System Integrity successes."
  block:
      - name: "MEDIUM | WN16-AU-000440 | AUDIT | Windows Server 2016 must be configured to audit System - System Integrity successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000440_audit
        check_mode: no
        changed_when: "'Success' not in wn16_au_000440_audit.stdout"

      - name: "MEDIUM | WN16-AU-000440 | PATCH | Windows Server 2016 must be configured to audit System - System Integrity successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"System Integrity" /success:enable
        check_mode: no
        when: "'Success' not in wn16_au_000440_audit.stdout"
  when:
      - wn16_au_000440
  tags:
      - WN16-AU-000440
      - xccdf_mil.disa.stig_rule_SV-88141r1_rule
      - tested

- name: "MEDIUM | WN16-AU-000450 | Windows Server 2016 must be configured to audit System - System Integrity failures."
  block:
      - name: "MEDIUM | WN16-AU-000450 | AUDIT | Windows Server 2016 must be configured to audit System - System Integrity failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        register: wn16_au_000450_audit
        check_mode: no
        changed_when: "'Failure' not in wn16_au_000450_audit.stdout"

      - name: "MEDIUM | WN16-AU-000450 | PATCH | Windows Server 2016 must be configured to audit System - System Integrity failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"System Integrity" /failure:enable
        check_mode: no
        when: "'Failure' not in wn16_au_000450_audit.stdout"
  when:
      - wn16_au_000450
  tags:
      - WN16-AU-000450
      - xccdf_mil.disa.stig_rule_SV-88143r1_rule
      - tested

# some versions may be core/no gui, may need a prelim to detect?
- name: "MEDIUM | WN16-CC-000010 | The display of slide shows on the lock screen must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization
      state: present
      value: NoLockScreenSlideshow
      data: 1
      datatype: dword
  when:
      - wn16_cc_000010
  tags:
      - WN16-CC-000010
      - xccdf_mil.disa.stig_rule_SV-88145r1_rule
      - tested

- name: "MEDIUM | WN16-MS-000020 | Local administrator accounts must have their privileged token filtered to prevent elevated privileges from being used over the network on domain systems."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: LocalAccountTokenFilterPolicy
      data: 0
      datatype: dword
  when:
      - wn16_ms_000020
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000020
      - xccdf_mil.disa.stig_rule_SV-88147r1_rule

- name: "MEDIUM | WN16-CC-000030 | WDigest Authentication must be disabled on Windows Server 2016."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest
      state: present
      value: UseLogonCredential
      data: 0
      datatype: dword
  when:
      - wn16_cc_000030
  tags:
      - WN16-CC-000030
      - xccdf_mil.disa.stig_rule_SV-88149r2_rule
      - tested

- name: "MEDIUM | WN16-CC-000080 | Insecure logons to an SMB server must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\LanmanWorkstation
      state: present
      value: AllowInsecureGuestAuth
      data: 0
      datatype: dword
  when:
      - wn16_cc_000080
  tags:
      - WN16-CC-000080
      - xccdf_mil.disa.stig_rule_SV-88159r1_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366

# verify if this applies to DC or only MS?
- name: "MEDIUM | WN16-CC-000090 | Hardened UNC paths must be defined to require mutual authentication and integrity for at least the SYSVOL and NETLOGON shares."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\NetworkProvider\HardenedPaths
      state: present
      value: "{{ item }}"
      data: RequireMutualAuthentication=1, RequireIntegrity=1
      datatype: string
  loop:
      - \\*\SYSVOL
      - \\*\NETLOGON
  when:
      - wn16_cc_000090
      - ansible_windows_domain_member
  tags:
      - WN16-CC-000090
      - xccdf_mil.disa.stig_rule_SV-88161r1_rule

- name: "MEDIUM | WN16-CC-000100 | Command line data must be included in process creation events."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit
      state: present
      value: ProcessCreationIncludeCmdLine_Enabled
      data: 1
      datatype: dword
  when:
      - wn16_cc_000100
  tags:
      - WN16-CC-000100
      - xccdf_mil.disa.stig_rule_SV-88163r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000110 | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."
  block:
      - name: "MEDIUM | WN16-CC-000110 | AUDIT | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."
        ansible.windows.win_shell: echo true
        register: wn16_cc_000110_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-CC-000110 | PATCH | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_cc_000110
      - ansible_windows_domain_member
  tags:
      - WN16-CC-000110
      - xccdf_mil.disa.stig_rule_SV-88165r2_rule
      - notimplemented
      - notest

- name: "MEDIUM | WN16-CC-000140 | Early Launch Antimalware, Boot-Start Driver Initialization Policy must prevent boot drivers identified as bad."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch
      state: present
      value: DriverLoadPolicy
      data: 1
      datatype: dword
  when:
      - wn16_cc_000140
  tags:
      - WN16-CC-000140
      - xccdf_mil.disa.stig_rule_SV-88173r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000150 | Group Policy objects must be reprocessed even if they have not changed."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}
      state: present
      value: NoGPOListChanges
      data: 0
      datatype: dword
  when:
      - wn16_cc_000150
  tags:
      - WN16-CC-000150
      - xccdf_mil.disa.stig_rule_SV-88177r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000160 | Downloading print driver packages over HTTP must be prevented."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
      state: present
      value: DisableWebPnPDownload
      data: 1
      datatype: dword
  when:
      - wn16_cc_000160
  tags:
      - WN16-CC-000160
      - xccdf_mil.disa.stig_rule_SV-88179r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000170 | Printing over HTTP must be prevented."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
      state: present
      value: DisableHTTPPrinting
      data: 1
      datatype: dword
  when:
      - wn16_cc_000170
  tags:
      - WN16-CC-000170
      - xccdf_mil.disa.stig_rule_SV-88181r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000180 | The network selection user interface (UI) must not be displayed on the logon screen."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      state: present
      value: DontDisplayNetworkSelectionUI
      data: 1
      datatype: dword
  when:
      - wn16_cc_000180
  tags:
      - WN16-CC-000180
      - xccdf_mil.disa.stig_rule_SV-88185r1_rule
      - tested

- name: "MEDIUM | WN16-MS-000030 | Local users on domain-joined computers must not be enumerated."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      state: present
      value: EnumerateLocalUsers
      data: 0
      datatype: dword
  when:
      - wn16_ms_000030
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000030
      - xccdf_mil.disa.stig_rule_SV-88187r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000210 | Users must be prompted to authenticate when the system wakes from sleep (on battery)."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      state: present
      value: DCSettingIndex
      data: 1
      datatype: dword
  when:
      - wn16_cc_000210
  tags:
      - WN16-CC-000210
      - xccdf_mil.disa.stig_rule_SV-88197r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000220 | Users must be prompted to authenticate when the system wakes from sleep (plugged in)."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      state: present
      value: ACSettingIndex
      data: 1
      datatype: dword
  when:
      - wn16_cc_000220
  tags:
      - WN16-CC-000220
      - xccdf_mil.disa.stig_rule_SV-88201r1_rule
      - tested

- name: "MEDIUM | WN16-MS-000040 | Unauthenticated Remote Procedure Call (RPC) clients must be restricted from connecting to the RPC server."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc
      state: present
      value: RestrictRemoteClients
      data: 1
      datatype: dword
  when:
      - wn16_ms_000040
  tags:
      - WN16-MS-000040
      - xccdf_mil.disa.stig_rule_SV-88203r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000290 | Windows Telemetry must be configured to Security or Basic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      state: present
      value: AllowTelemetry
      data: 0
      datatype: dword
  when:
      - wn16_cc_000290
  tags:
      - WN16-CC-000290
      - xccdf_mil.disa.stig_rule_SV-88215r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000300 | The Application event log size must be configured to 32768 KB or greater."
  block:
      - name: "MEDIUM | WN16-CC-000300 | AUDIT | The Application event log size must be configured to 32768 KB or greater."
        ansible.windows.win_reg_stat:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
            name: MaxSize
        register: wn16_cc_000300_audit
        changed_when: no

      - name: "MEDIUM | WN16-CC-000300 | PATCH | The Application event log size must be configured to 32768 KB or greater."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
            state: present
            value: MaxSize
            data: "{{ wn16_cc_000300_app_maxsize }}"
            datatype: dword
        when: not wn16_cc_000300_audit.exists or wn16_cc_000300_audit.value < 32768
  when:
      - wn16_cc_000300
  tags:
      - WN16-CC-000300
      - xccdf_mil.disa.stig_rule_SV-88217r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000310 | The Security event log size must be configured to 196608 KB or greater."
  block:
      - name: "MEDIUM | WN16-CC-000310 | AUDIT | The Security event log size must be configured to 196608 KB or greater."
        ansible.windows.win_reg_stat:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
            name: MaxSize
        register: wn16_cc_000310_audit
        changed_when: no
      - name: "MEDIUM | WN16-CC-000310 | PATCH | The Security event log size must be configured to 196608 KB or greater."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
            state: present
            value: MaxSize
            data: "{{ wn16_cc_000310_sec_maxsize }}"
            datatype: dword
        when: not wn16_cc_000310_audit.exists or wn16_cc_000310_audit.value < 196608
  when:
      - wn16_cc_000310
  tags:
      - WN16-CC-000310
      - xccdf_mil.disa.stig_rule_SV-88219r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000320 | The System event log size must be configured to 32768 KB or greater."
  block:
      - name: "MEDIUM | WN16-CC-000320 | AUDIT | The System event log size must be configured to 32768 KB or greater."
        ansible.windows.win_reg_stat:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System
            name: MaxSize
        register: wn16_cc_000320_audit
        changed_when: no

      - name: "MEDIUM | WN16-CC-000320 | PATCH | The System event log size must be configured to 32768 KB or greater."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System
            state: present
            value: MaxSize
            data: "{{ wn16_cc_000320_sys_maxsize }}"
            datatype: dword
        when: not wn16_cc_000320_audit.exists or wn16_cc_000320_audit.value < 32768
  when:
      - wn16_cc_000320
  tags:
      - WN16-CC-000320
      - xccdf_mil.disa.stig_rule_SV-88221r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000330 | Windows Server 2016 Windows SmartScreen must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      state: present
      value: EnableSmartScreen
      data: 1
      datatype: dword
  when:
      - wn16_cc_000330
  tags:
      - WN16-CC-000330
      - xccdf_mil.disa.stig_rule_SV-88223r2_rule
      - tested

- name: "MEDIUM | WN16-CC-000340 | Explorer Data Execution Prevention must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer
      state: present
      value: NoDataExecutionPrevention
      data: 0
      datatype: dword
  when:
      - wn16_cc_000340
  tags:
      - WN16-CC-000340
      - xccdf_mil.disa.stig_rule_SV-88225r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000360 | File Explorer shell protocol must run in protected mode."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
      state: present
      value: PreXPSP2ShellProtocolBehavior
      data: 0
      datatype: dword
  when:
      - wn16_cc_000360
  tags:
      - WN16-CC-000360
      - xccdf_mil.disa.stig_rule_SV-88229r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000370 | Passwords must not be saved in the Remote Desktop Client."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: DisablePasswordSaving
      data: 1
      datatype: dword
  when:
      - wn16_cc_000370
  tags:
      - WN16-CC-000370
      - xccdf_mil.disa.stig_rule_SV-88231r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000380 | Local drives must be prevented from sharing with Remote Desktop Session Hosts."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: fDisableCdm
      data: 1
      datatype: dword
  when:
      - wn16_cc_000380
  tags:
      - WN16-CC-000380
      - xccdf_mil.disa.stig_rule_SV-88233r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000390 | Remote Desktop Services must always prompt a client for passwords upon connection."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: fPromptForPassword
      data: 1
      datatype: dword
  when:
      - wn16_cc_000390
  tags:
      - WN16-CC-000390
      - xccdf_mil.disa.stig_rule_SV-88235r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000400 | The Remote Desktop Session Host must require secure Remote Procedure Call (RPC) communications."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: fEncryptRPCTraffic
      data: 1
      datatype: dword
  when:
      - wn16_cc_000400
  tags:
      - WN16-CC-000400
      - xccdf_mil.disa.stig_rule_SV-88237r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000410 | Remote Desktop Services must be configured with the client connection encryption set to High Level."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: MinEncryptionLevel
      data: 3
      datatype: dword
  when:
      - wn16_cc_000410
  tags:
      - WN16-CC-000410
      - xccdf_mil.disa.stig_rule_SV-88239r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000420 | Attachments must be prevented from being downloaded from RSS feeds."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds
      state: present
      value: DisableEnclosureDownload
      data: 1
      datatype: dword
  when:
      - wn16_cc_000420
  tags:
      - WN16-CC-000420
      - xccdf_mil.disa.stig_rule_SV-88241r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000421 | The Windows Explorer Preview pane must be disabled for Windows Server 2016."
  ansible.windows.win_regedit:
      path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
      state: present
      value: NoPreviewPane
      data: 1
      datatype: dword
  when:
      - wn16_cc_000421
  tags:
      - WN16-CC-000421
      - xccdf_mil.disa.stig_rule_SV-224950r569186_rule

- name: "MEDIUM | WN16-CC-000430 | Basic authentication for RSS feeds over HTTP must not be used."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds
      state: present
      value: AllowBasicAuthInClear
      data: 0
      datatype: dword
  when:
      - wn16_cc_000430
  tags:
      - WN16-CC-000430
      - xccdf_mil.disa.stig_rule_SV-88243r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000440 | Indexing of encrypted files must be turned off."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Search
      state: present
      value: AllowIndexingEncryptedStoresOrItems
      data: 0
      datatype: dword
  when:
      - wn16_cc_000440
  tags:
      - WN16-CC-000440
      - xccdf_mil.disa.stig_rule_SV-88245r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000450 | Users must be prevented from changing installation options."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer
      state: present
      value: EnableUserControl
      data: 0
      datatype: dword
  when:
      - wn16_cc_000450
  tags:
      - WN16-CC-000450
      - xccdf_mil.disa.stig_rule_SV-88247r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000470 | Users must be notified if a web-based program attempts to install software."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer
      state: present
      value: SafeForScripting
      data: 0
      datatype: dword
  when:
      - wn16_cc_000470
  tags:
      - WN16-CC-000470
      - xccdf_mil.disa.stig_rule_SV-88251r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000480 | Automatically signing in the last interactive user after a system-initiated restart must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: DisableAutomaticRestartSignOn
      data: 1
      datatype: dword
  when:
      - wn16_cc_000480
  tags:
      - WN16-CC-000480
      - xccdf_mil.disa.stig_rule_SV-88253r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000490 | PowerShell script block logging must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
      state: present
      value: EnableScriptBlockLogging
      data: 1
      datatype: dword
  when:
      - wn16_cc_000490
  tags:
      - WN16-CC-000490
      - xccdf_mil.disa.stig_rule_SV-88255r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000510 | The Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
      state: present
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  when:
      - wn16_cc_000510
      - not winstig_skip_for_test
  tags:
      - WN16-CC-000510
      - xccdf_mil.disa.stig_rule_SV-88259r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000520 | The Windows Remote Management (WinRM) client must not use Digest authentication."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
      state: present
      value: AllowDigest
      data: 0
      datatype: dword
  when:
      - wn16_cc_000520
  tags:
      - WN16-CC-000520
      - xccdf_mil.disa.stig_rule_SV-88261r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000540 | The Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
      state: present
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  when:
      - wn16_cc_000540
      - not winstig_skip_for_test
  tags:
      - WN16-CC-000540
      - xccdf_mil.disa.stig_rule_SV-88265r1_rule
      - tested

- name: "MEDIUM | WN16-CC-000550 | The Windows Remote Management (WinRM) service must not store RunAs credentials."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
      state: present
      value: DisableRunAs
      data: 1
      datatype: dword
  when:
      - wn16_cc_000550
      - not winstig_skip_for_test
  tags:
      - WN16-CC-000550
      - xccdf_mil.disa.stig_rule_SV-88267r1_rule
      - tested

# https://dl.dod.cyber.mil/wp-content/uploads/pki-pke/zip/certificates_pkcs7_v5-6_dod.zip ?
- name: "MEDIUM | WN16-PK-000010 | The DoD Root CA certificates must be installed in the Trusted Root Store."
  block:
      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store."
        ansible.windows.win_shell: echo true
        register: wn16_pk_000010_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-PK-000010 | PATCH | The DoD Root CA certificates must be installed in the Trusted Root Store."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_pk_000010
  tags:
      - WN16-PK-000010
      - xccdf_mil.disa.stig_rule_SV-88269r3_rule
      - notimplemented
      - notest

- name: "MEDIUM | WN16-PK-000020 | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
  block:
      - name: "MEDIUM | WN16-PK-000020 | AUDIT | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
        ansible.windows.win_shell: echo true
        register: wn16_pk_000020_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-PK-000020 | PATCH | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_pk_000020
  tags:
      - WN16-PK-000020
      - notimplemented
      - notest

- name: "MEDIUM | WN16-PK-000030 | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
  block:
      - name: "MEDIUM | WN16-PK-000030 | AUDIT | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\disallowed | Where Issuer -Like "*CCEB Interoperability*" | FL Subject, Issuer, Thumbprint, NotAfter
        register: wn16_pk_000030_audit
        check_mode: no
        changed_when: no
        failed_when: no

      - name: "MEDIUM | WN16-PK-000030 | PATCH | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_pk_000030
  tags:
      - WN16-PK-000030
      - SV-88273r3
      - notimplemented
      - notest

- name: "MEDIUM | WN16-DC-000280 | Domain controllers must have a PKI server certificate."
  block:
      - name: "MEDIUM | WN16-DC-000280 | AUDIT | Domain controllers must have a PKI server certificate."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000280_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000280 | PATCH | Domain controllers must have a PKI server certificate."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000280
  tags:
      - WN16-DC-000280
      - notimplemented
      - notest

- name: "MEDIUM | WN16-DC-000310 | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
  block:
      - name: "MEDIUM | WN16-DC-000310 | AUDIT | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
        ansible.windows.win_shell: echo true
        register: wn16_dc_000310_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-DC-000310 | PATCH | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000310
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000310
      - notimplemented
      - notest

- name: "MEDIUM | WN16-SO-000030 | Windows Server 2016 built-in administrator account must be renamed."
  community.windows.win_security_policy:
      section: System Access
      key: NewAdministratorName
      value: "{{ wn16_so_000030_newadministratorname }}"
  when:
      - wn16_so_000030
      - not winstig_skip_for_test
  tags:
      - WN16-SO-000030
      - SV-88287r2

- name: "MEDIUM | WN16-SO-000040 | Windows Server 2016 built-in guest account must be renamed."
  community.windows.win_security_policy:
      section: System Access
      key: NewGuestName
      value: "{{ wn16_so_000040_newguestname }}"
  when:
      - wn16_so_000040
  tags:
      - WN16-SO-000040
      - SV-88289r2

- name: "MEDIUM | WN16-SO-000050 | Audit policy using subcategories must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\
      state: present
      value: SCENoApplyLegacyAuditPolicy
      data: 1
      datatype: dword
  when:
      - wn16_so_000050
  tags:
      - WN16-SO-000050
      - xccdf_mil.disa.stig_rule_SV-88291r1_rule

- name: "MEDIUM | WN16-DC-000320 | Domain controllers must require LDAP access signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters
      state: present
      value: LDAPServerIntegrity
      data: 2
      datatype: dword
  when:
      - wn16_dc_000320
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000320
      - SV-88293r1_rule

- name: "MEDIUM | WN16-DC-000330 | Domain controllers must be configured to allow reset of machine account passwords."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: RefusePasswordChange
      data: 0
      datatype: dword
  when:
      - wn16_dc_000330
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000330
      - SV-88295r1_rule

- name: "MEDIUM | WN16-SO-000080 | The setting Domain member: Digitally encrypt or sign secure channel data (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: RequireSignOrSeal
      data: 1
      datatype: dword
  when:
      - wn16_so_000080
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-SO-000080
      - SV-88297r1

- name: "MEDIUM | WN16-SO-000090 | The setting Domain member: Digitally encrypt secure channel data (when possible) must be configured to enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: SealSecureChannel
      data: 1
      datatype: dword
  when:
      - wn16_so_000090
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-SO-000090
      - SV-88299r1

- name: "MEDIUM | WN16-SO-000100 | The setting Domain member: Digitally sign secure channel data (when possible) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: SignSecureChannel
      data: 1
      datatype: dword
  when:
      - wn16_so_000100
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-SO-000100
      - SV-88301r1

- name: "MEDIUM | WN16-SO-000110 | The computer account password must not be prevented from being reset."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: DisablePasswordChange
      data: 0
      datatype: dword
  when:
      - wn16_so_000110
  tags:
      - WN16-SO-000110
      - SV-88303r1

- name: "MEDIUM | WN16-SO-000120 | The maximum age for machine account passwords must be configured to 30 days or less."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: MaximumPasswordAge
      data: 30
      datatype: dword
  when:
      - wn16_so_000120
  tags:
      - WN16-SO-000120
      - SV-88305r1

- name: "MEDIUM | WN16-SO-000130 | Windows Server 2016 must be configured to require a strong session key."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: RequireStrongKey
      data: 1
      datatype: dword
  when:
      - wn16_so_000130
  tags:
      - WN16-SO-000130
      - SV-88307r1

- name: "MEDIUM | WN16-SO-000140 | The machine inactivity limit must be set to 15 minutes, locking the system with the screen saver."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: InactivityTimeoutSecs
      data: 900
      datatype: dword
  when:
      - wn16_so_000140
  tags:
      - WN16-SO-000140
      - xccdf_mil.disa.stig_rule_SV-88309r2_rule

- name: "MEDIUM | WN16-SO-000150 | The required legal notice must be configured to display before console logon."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: LegalNoticeText
      data: "{{ wn16_so_000150_legalnoticetext }}"
      datatype: string
  when:
      - wn16_so_000150
  tags:
      - WN16-SO-000150
      - xccdf_mil.disa.stig_rule_SV-88311r2_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-MS-000050 | Caching of logon credentials must be limited."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      state: present
      value: CachedLogonsCount
      data: 4
      datatype: dword
  when:
      - wn16_ms_000050
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000050
      - xccdf_mil.disa.stig_rule_SV-88315r1_rule

- name: "MEDIUM | WN16-SO-000190 | The setting Microsoft network client: Digitally sign communications (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      state: present
      value: RequireSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000190
  tags:
      - WN16-SO-000190
      - xccdf_mil.disa.stig_rule_SV-88317r1_rule

- name: "MEDIUM | WN16-SO-000200 | The setting Microsoft network client: Digitally sign communications (if server agrees) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      state: present
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000200
  tags:
      - WN16-SO-000200
      - xccdf_mil.disa.stig_rule_SV-88319r1_rule

- name: "MEDIUM | WN16-SO-000210 | Unencrypted passwords must not be sent to third-party Server Message Block (SMB) servers."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      state: present
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  when:
      - wn16_so_000210
  tags:
      - WN16-SO-000210
      - xccdf_mil.disa.stig_rule_SV-88321r1_rule

- name: "MEDIUM | WN16-SO-000230 | The setting Microsoft network server: Digitally sign communications (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters
      state: present
      value: RequireSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000230
  tags:
      - WN16-SO-000230
      - xccdf_mil.disa.stig_rule_SV-88325r1_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-SO-000240 | The setting Microsoft network server: Digitally sign communications (if client agrees) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters
      state: present
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000240
  tags:
      - WN16-SO-000240
      - xccdf_mil.disa.stig_rule_SV-88327r1_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-SO-000290 | Windows Server 2016 must be configured to prevent anonymous users from having the same permissions as the Everyone group."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      state: present
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  when:
      - wn16_so_000290
  tags:
      - WN16-SO-000290
      - xccdf_mil.disa.stig_rule_SV-88337r1_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-MS-000310 | Remote calls to the Security Account Manager (SAM) must be restricted to Administrators."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      state: present
      value: RestrictRemoteSAM
      data: O:BAG:BAD:(A;;RC;;;BA)
      datatype: string
  when:
      - wn16_ms_000310
  tags:
      - WN16-MS-000310
      - xccdf_mil.disa.stig_rule_SV-88341r2_rule

- name: "MEDIUM | WN16-SO-000320 | Services using Local System that use Negotiate when reverting to NTLM authentication must use the computer identity instead of authenticating anonymously."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      state: present
      value: UseMachineId
      data: 1
      datatype: dword
  when:
      - wn16_so_000320
  tags:
      - WN16-SO-000320
      - xccdf_mil.disa.stig_rule_SV-88343r1_rule

- name: "MEDIUM | WN16-SO-000330 | NTLM must be prevented from falling back to a Null session."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      state: present
      value: allownullsessionfallback
      data: 0
      datatype: dword
  when:
      - wn16_so_000330
  tags:
      - WN16-SO-000330
      - xccdf_mil.disa.stig_rule_SV-88345r1_rule

- name: "MEDIUM | WN16-SO-000340 | PKU2U authentication using online identities must be prevented."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\pku2u
      state: present
      value: AllowOnlineID
      data: 0
      datatype: dword
  when:
      - wn16_so_000340
  tags:
      - WN16-SO-000340
      - xccdf_mil.disa.stig_rule_SV-88347r1_rule

- name: "MEDIUM | WN16-SO-000350 | Kerberos encryption types must be configured to prevent the use of DES and RC4 encryption suites."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters
      state: present
      value: SupportedEncryptionTypes
      data: 2147483640
      datatype: dword
  when:
      - wn16_so_000350
  tags:
      - WN16-SO-000350
      - xccdf_mil.disa.stig_rule_SV-88349r2_rule

- name: "MEDIUM | WN16-SO-000390 | Windows Server 2016 must be configured to at least negotiate signing for LDAP client signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LDAP
      state: present
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  when:
      - wn16_so_000390
  tags:
      - WN16-SO-000390
      - xccdf_mil.disa.stig_rule_SV-88357r1_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-SO-000400 | Session security for NTLM SSP-based clients must be configured to require NTLMv2 session security and 128-bit encryption."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      state: present
      value: NTLMMinClientSec
      data: 537395200
      datatype: dword
  when:
      - wn16_so_000400
  tags:
      - WN16-SO-000400
      - xccdf_mil.disa.stig_rule_SV-88359r1_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-SO-000410 | Session security for NTLM SSP-based servers must be configured to require NTLMv2 session security and 128-bit encryption."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      state: present
      value: NTLMMinServerSec
      data: 537395200
      datatype: dword
  when:
      - wn16_so_000410
  tags:
      - WN16-SO-000410
      - xccdf_mil.disa.stig_rule_SV-88361r1_rule
      - borked_regkey_casesensitive

- name: "MEDIUM | WN16-SO-000420 | Users must be required to enter a password to access private keys stored on the computer."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Cryptography
      state: present
      value: ForceKeyProtection
      data: 2
      datatype: dword
  when:
      - wn16_so_000420
  tags:
      - WN16-SO-000420
      - xccdf_mil.disa.stig_rule_SV-88363r1_rule

- name: "MEDIUM | WN16-SO-000430 | Windows Server 2016 must be configured to use FIPS-compliant algorithms for encryption, hashing, and signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy
      state: present
      value: Enabled
      data: 1
      datatype: dword
  when:
      - wn16_so_000430
  tags:
      - WN16-SO-000430
      - xccdf_mil.disa.stig_rule_SV-88365r1_rule

- name: "MEDIUM | WN16-SO-000460 | User Account Control approval mode for the built-in Administrator must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: FilterAdministratorToken
      data: 1
      datatype: dword
  when:
      - wn16_so_000460
      - not winstig_skip_for_test
  tags:
      - WN16-SO-000460
      - xccdf_mil.disa.stig_rule_SV-88371r1_rule
      # - exclusions for server core? think its NA there

- name: "MEDIUM | WN16-SO-000470 | UIAccess applications must not be allowed to prompt for elevation without using the secure desktop."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableUIADesktopToggle
      data: 0
      datatype: dword
  when:
      - wn16_so_000470
  tags:
      - WN16-SO-000470
      - xccdf_mil.disa.stig_rule_SV-88373r1_rule

- name: "MEDIUM | WN16-SO-000480 | User Account Control must, at a minimum, prompt administrators for consent on the secure desktop."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: ConsentPromptBehaviorAdmin
      data: 2
      datatype: dword
  when:
      - wn16_so_000480
  tags:
      - WN16-SO-000480
      - xccdf_mil.disa.stig_rule_SV-88375r1_rule

- name: "MEDIUM | WN16-SO-000490 | User Account Control must automatically deny standard user requests for elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: ConsentPromptBehaviorUser
      data: 0
      datatype: dword
  when:
      - wn16_so_000490
  tags:
      - WN16-SO-000490
      - xccdf_mil.disa.stig_rule_SV-88377r1_rule

- name: "MEDIUM | WN16-SO-000500 | User Account Control must be configured to detect application installations and prompt for elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableInstallerDetection
      data: 1
      datatype: dword
  when:
      - wn16_so_000500
  tags:
      - WN16-SO-000500
      - SV-88379r1

- name: "MEDIUM | WN16-SO-000510 | User Account Control must only elevate UIAccess applications that are installed in secure locations."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableSecureUIAPaths
      data: 1
      datatype: dword
  when:
      - wn16_so_000510
  tags:
      - WN16-SO-000510
      - SV-88381r1

- name: "MEDIUM | WN16-SO-000520 | User Account Control must run all administrators in Admin Approval Mode, enabling UAC."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableLUA
      data: 1
      datatype: dword
  when:
      - wn16_so_000520
  tags:
      - WN16-SO-000520
      - SV-88383r1

- name: "MEDIUM | WN16-SO-000530 | User Account Control must virtualize file and registry write failures to per-user locations."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableVirtualization
      data: 1
      datatype: dword
  when:
      - wn16_so_000530
  tags:
      - WN16-SO-000530
      - SV-88385r1

- name: "MEDIUM | WN16-UC-000030 | Zone information must be preserved when saving attachments."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Attachments
      state: present
      value: SaveZoneInformation
      data: 2
      datatype: dword
  when:
      - wn16_uc_000030
  tags:
      - WN16-UC-000030
      - SV-88391r1_rule

- name: "MEDIUM | WN16-UR-000010 | The Access Credential Manager as a trusted caller user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeTrustedCredManAccessPrivilege
      value: ""
  when:
      - wn16_ur_000010
  tags:
      - WN16-UR-000010
      - SV-88393r2

- name: "MEDIUM | WN16-DC-000340 | The Access this computer from the network user right must only be assigned to the Administrators, Authenticated Users, and Enterprise Domain Controllers groups on domain controllers."
  ansible.windows.win_user_right:
      name: SeNetworkLogonRight
      users:
          - Administrators
          - Authenticated Users
          - Enterprise Domain Controllers
      action: set
  when:
      - wn16_dc_000340
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000340
      - SV-88395r3_rule

- name: "MEDIUM | WN16-MS-000340 | The Access this computer from the network user right must only be assigned to the Administrators and Authenticated Users groups on member servers."
  ansible.windows.win_user_right:
      name: SeNetworkLogonRight
      users:
          - Administrators
          - Authenticated Users
      action: set
  when:
      - wn16_ms_000340
  tags:
      - WN16-MS-000340
      - SV-88397r3

- name: "MEDIUM | WN16-DC-000350 | The Add workstations to domain user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeMachineAccountPrivilege
      users: Administrators
      action: set
  when:
      - wn16_dc_000350
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000350
      - SV-88401r2_rule

- name: "MEDIUM | WN16-UR-000050 | The Allow log on locally user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeInteractiveLogonRight
      users: Administrators
      action: set
  when:
      - wn16_ur_000050
  tags:
      - WN16-UR-000050
      - SV-88403r2

- name: "MEDIUM | WN16-DC-000360 | The Allow log on through Remote Desktop Services user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRemoteInteractiveLogonRight
      users: Administrators
      action: set
  when:
      - wn16_dc_000360
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000360
      - SV-88405r2

- name: "MEDIUM | WN16-UR-000070 | The Back up files and directories user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeBackupPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000070
  tags:
      - WN16-UR-000070
      - SV-88407r2
      - borked_passes_when_empty

- name: "MEDIUM | WN16-UR-000080 | The Create a pagefile user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeCreatePagefilePrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000080
  tags:
      - WN16-UR-000080
      - SV-88409r2
      - borked_passes_when_empty

- name: "MEDIUM | WN16-UR-000100 | The Create global objects user right must only be assigned to Administrators, Service, Local Service, and Network Service."
  ansible.windows.win_user_right:
      name: SeCreateGlobalPrivilege
      users:
          - Administrators
          - Service
          - "Local Service"
          - Network Service
      action: set
  when:
      - wn16_ur_000100
  tags:
      - WN16-UR-000100
      - SV-88413r2

- name: "MEDIUM | WN16-UR-000110 | The Create permanent shared objects user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeCreatePermanentPrivilege
      value: ""
  when:
      - wn16_ur_000110
  tags:
      - WN16-UR-000110
      - SV-88415r2

- name: "MEDIUM | WN16-UR-000120 | The Create symbolic links user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeCreateSymbolicLinkPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000120
  tags:
      - WN16-UR-000120
      - SV-88417r2

- name: "MEDIUM | WN16-DC-000370 | The Deny access to this computer from the network user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyNetworkLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000370
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000370
      - SV-88421r2

- name: "MEDIUM | WN16-MS-000370 | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and local accounts on domain systems, and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000370 | AUDIT | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and local accounts on domain systems, and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyNetworkLogonRight
            users:
                - Guests
                - Enterprise Admins
                - Domain Admins
                - Local account
                - Local account and member of Administrators group
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000370 | PATCH | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and local accounts on domain systems, and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyNetworkLogonRight
            users: Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000370
  tags:
      - WN16-MS-000370
      - SV-88423r3
      - borked_if_ansible_svc_is_admin_domain_member_fails_after

- name: "MEDIUM | WN16-DC-000380 | The Deny log on as a batch job user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyBatchLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000380
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000380
      - SV-88425r2

- name: "MEDIUM | WN16-MS-000380 | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000380 | DOMAIN MEMBER | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Enterprise Admins
                - Domain Admins
                - Guests
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000380 | STAND-ALONE | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000380
  tags:
      - WN16-MS-000380
      - SV-88427r2

- name: "MEDIUM | WN16-DC-000390 | The Deny log on as a service user right must be configured to include no accounts or groups (blank) on domain controllers."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeDenyServiceLogonRight
      value: ""
  when:
      - wn16_dc_000390
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000390
      - SV-88429r2

- name: "MEDIUM | WN16-MS-000390 | The Deny log on as a service user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems. No other groups or accounts must be assigned this right."
  ansible.windows.win_user_right:
      name: SeDenyServiceLogonRight
      users:
          - Enterprise Admins
          - Domain Admins
      action: set
  when:
      - wn16_ms_000390
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000390
      - SV-88431r2

- name: "MEDIUM | WN16-DC-000400 | The Deny log on locally user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyInteractiveLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000400
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000400
      - SV-88433r2

- name: "MEDIUM | WN16-MS-000400 | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000400 | DOMAIN MEMBER | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyInteractiveLogonRight
            users:
                - Guests
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000400 | STAND-ALONE | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyInteractiveLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000400
  tags:
      - WN16-MS-000400
      - SV-88435r3

- name: "MEDIUM | WN16-DC-000410 | The Deny log on through Remote Desktop Services user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyRemoteInteractiveLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000410
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000410
      - SV-88437r2

- name: "MEDIUM | WN16-MS-000410 | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000410 | DOMAIN MEMBER | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyRemoteInteractiveLogonRight
            users:
                - Guests
                - Local account
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000410 | STAND-ALONE | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyRemoteInteractiveLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000410
  tags:
      - WN16-MS-000410
      - SV-88439r3

- name: "MEDIUM | WN16-DC-000420 | The Enable computer and user accounts to be trusted for delegation user right must only be assigned to the Administrators group on domain controllers."
  ansible.windows.win_user_right:
      name: SeEnableDelegationPrivilege
      users: Administrators
      action: set
  when:
      - wn16_dc_000420
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000420
      - SV-88441r2

- name: "MEDIUM | WN16-MS-000420 | The Enable computer and user accounts to be trusted for delegation user right must not be assigned to any groups or accounts on member servers."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeEnableDelegationPrivilege
      value: ""
  when:
      - wn16_ms_000420
  tags:
      - WN16-MS-000420
      - SV-88443r2

- name: "MEDIUM | WN16-UR-000200 | The Force shutdown from a remote system user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRemoteShutdownPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000200
  tags:
      - WN16-UR-000200
      - SV-88445r2
      - borked_passes_when_empty

- name: "MEDIUM | WN16-UR-000210 | The Generate security audits user right must only be assigned to Local Service and Network Service."
  ansible.windows.win_user_right:
      name: SeAuditPrivilege
      users:
          - Local Service
          - Network Service
      action: set
  when:
      - wn16_ur_000210
  tags:
      - WN16-UR-000210
      - SV-88447r2

- name: "MEDIUM | WN16-UR-000220 | The Impersonate a client after authentication user right must only be assigned to Administrators, Service, Local Service, and Network Service."
  ansible.windows.win_user_right:
      name: SeImpersonatePrivilege
      users:
          - Administrators
          - Service
          - Local Service
          - Network Service
      action: set
  when:
      - wn16_ur_000220
  tags:
      - WN16-UR-000220
      - xccdf_mil.disa.stig_rule_SV-88449r2_rule

- name: "MEDIUM | WN16-UR-000230 | The Increase scheduling priority user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeIncreaseBasePriorityPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000230
  tags:
      - WN16-UR-000230
      - xccdf_mil.disa.stig_rule_SV-88451r2_rule
      - borked_passes_when_empty

- name: "MEDIUM | WN16-UR-000240 | The Load and unload device drivers user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeLoadDriverPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000240
  tags:
      - WN16-UR-000240
      - xccdf_mil.disa.stig_rule_SV-88453r2_rule
      - borked_passes_when_empty

- name: "MEDIUM | WN16-UR-000250 | The Lock pages in memory user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeLockMemoryPrivilege
      value: ""
  when:
      - wn16_ur_000250
  tags:
      - WN16-UR-000250
      - SV-88455r2_rule

- name: "MEDIUM | WN16-UR-000260 | The Manage auditing and security log user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeSecurityPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000260
  tags:
      - WN16-UR-000260
      - SV-88457r2_rule

- name: "MEDIUM | WN16-UR-000270 | The Modify firmware environment values user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeSystemEnvironmentPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000270
  tags:
      - WN16-UR-000270
      - SV-88459r2_rule

- name: "MEDIUM | WN16-UR-000280 | The Perform volume maintenance tasks user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeManageVolumePrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000280
  tags:
      - WN16-UR-000280
      - SV-88461r2_rule

- name: "MEDIUM | WN16-UR-000290 | The Profile single process user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeProfileSingleProcessPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000290
  tags:
      - WN16-UR-000290
      - SV-88463r2

- name: "MEDIUM | WN16-UR-000300 | The Restore files and directories user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRestorePrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000300
  tags:
      - WN16-UR-000300
      - SV-88465r2_rule

- name: "MEDIUM | WN16-UR-000310 | The Take ownership of files or other objects user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeTakeOwnershipPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000310
  tags:
      - WN16-UR-000310
      - SV-88467r2_rule

- name: "MEDIUM | WN16-SO-000180 | The Smart Card removal option must be configured to Force Logoff or Lock Workstation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      state: present
      value: scremoveoption
      data: 1
      datatype: string
  when:
      - wn16_so_000180
  tags:
      - WN16-SO-000180
      - xccdf_mil.disa.stig_rule_SV-88473r1_rule

- name: "MEDIUM | WN16-SO-000010 | Windows Server 2016 built-in guest account must be disabled."
  community.windows.win_security_policy:
      section: System Access
      key: EnableGuestAccount
      value: 0
  when:
      - wn16_so_000010
  tags:
      - WN16-SO-000010
      - SV-88475r2

- name: "MEDIUM | WN16-00-000411 | The Server Message Block (SMB) v1 protocol must be disabled on the SMB server."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
      state: present
      value: SMB1
      data: 0
      datatype: dword
  when:
      - wn16_00_000411
  tags:
      - WN16-00-000411
      - xccdf_mil.disa.stig_rule_SV-92829r1_rule

- name: "MEDIUM | WN16-00-000412 | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client."
  block:
      - name: "MEDIUM | WN16-00-000412 | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client - mrxsmb10."
        ansible.windows.win_regedit:
            path: HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10
            state: present
            value: Start
            data: 4
            datatype: dword
      - name: "MEDIUM | WN16-00-000412 | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client - LanmanWorkstation."
        ansible.windows.win_regedit:
            path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation
            state: present
            value: DependOnService
            data: ['Bowser', 'MRxSmb20', 'NSI']
            datatype: multistring
  when:
      - wn16_00_000412
  tags:
      - WN16-00-000412
      - xccdf_mil.disa.stig_rule_SV-92831r1_rule
      - dfed_ask_if_use_loop

- name: "MEDIUM | WN16-00-000460 | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016."
  block:
      - name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016."
        ansible.windows.win_shell: echo true
        register: wn16_00_000460_audit
        check_mode: no
        changed_when: no

      - name: "MEDIUM | WN16-00-000460 | PATCH | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_00_000460
  tags:
      - WN16-00-000460
      - SV-92833r2_rule
      - notimplemented
      - notest
      - notfun
      # https://www.stigviewer.com/stig/windows_server_2016/2019-01-16/finding/V-78127

- name: "MEDIUM | WN16-AU-000285 | Windows 2016 must be configured to audit Object Access - Other Object Access Events successes."
  community.windows.win_audit_policy_system:
      subcategory: Other Object Access Events
      audit_type: success, failure
  when:
      - wn16_au_000285
  tags:
      - WN16-AU-000285
      - xccdf_mil.disa.stig_rule_SV-101009r1_rule

- name: "MEDIUM | WN16-AU-000286 | Windows 2016 must be configured to audit Object Access - Other Object Access Events failures."
  community.windows.win_audit_policy_system:
      subcategory: Other Object Access Events
      audit_type: success, failure
  when:
      - wn16_au_000286
  tags:
      - WN16-AU-000286
      - xccdf_mil.disa.stig_rule_SV-101011r1_rule

- name: "MEDIUM | WN16-DC-000430 | The password for the krbtgt account on a domain must be reset at least every 180 days."
  block:
      - name: "MEDIUM | WN16-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days."
        ansible.windows.win_shell: "Get-ADUser krbtgt -Property PasswordLastSet | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16_dc_000430_pass_age }}))} | Select-Object -ExpandProperty PasswordLastSet"
        register: wn16_dc_000430_audit
        check_mode: no
        changed_when: wn16_dc_000430_audit.stdout != ""

      ## this seems highly prone to breakage? its a DC acct, has replicate. if you screw it up, it could stop kerberos tickets and break auth things
      ## https://www.kjctech.net/do-you-need-to-update-krbtgt-account-password/
      - name: "MEDIUM | WN16-DC-000430 | PATCH | The password for the krbtgt account on a domain must be reset at least every 180 days."
        ansible.windows.win_shell: echo true
        changed_when: no
  when:
      - wn16_dc_000430
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000430
      - win2k16_disruption_high
      - notimplemented

- name: "MEDIUM | WN16-00-000300 | The roles and features required by the system must be documented."
  block:
      - name: "MEDIUM | WN16-00-000300 | AUDIT | The roles and features required by the system must be documented."
        ansible.windows.win_shell: Get-WindowsFeature | Where InstallState -Eq Installed
        register: wn16_00_000300_audit
        check_mode: no
        changed_when: no
      - ansible.builtin.debug:
            var: wn16_00_000300_audit.stdout_lines
  when:
      - wn16_00_000300
  tags:
      - WN16-00-000300
      - SV-87929r1
      - notimplemented
      - notest
